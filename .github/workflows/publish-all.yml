name: Publish All Packages to NuGet

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Set version
        id: version
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Pack and Publish
        run: |
          echo "ğŸ“¦ Packing and publishing version ${{ steps.version.outputs.VERSION }}..."
          
          # src/ altÄ±ndaki tÃ¼m .csproj dosyalarÄ±nÄ± bul
          for project in src/**/*.csproj; do
            # Proje adÄ±nÄ± al
            project_name=$(basename ${project%.csproj})
            version="${{ steps.version.outputs.VERSION }}"
          
            echo "ğŸ” Checking if $project_name v$version exists on NuGet.org..."
          
            # NuGet'te paket var mÄ± kontrol et
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://api.nuget.org/v3-flatcontainer/$project_name/$version/$project_name.$version.nupkg")
          
            if [ "$response" = "200" ]; then
              echo "â­ï¸  $project_name v$version already exists on NuGet.org, skipping..."
              continue
            fi
          
            echo "ğŸ”¨ Packing $project..."
          
            # Pack
            dotnet pack "$project" \
              --configuration ${{ env.CONFIGURATION }} \
              -p:Version=$version \
              --output ./nupkgs
          
            # Publish
            package="./nupkgs/${project_name}.${version}.nupkg"
            if [ -f "$package" ]; then
              echo "ğŸ“¤ Publishing $package..."
              dotnet nuget push "$package" \
                --api-key ${{ secrets.NUGET_API_KEY }} \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate
          
              if [ $? -eq 0 ]; then
                echo "âœ… $project_name published successfully!"
              else
                echo "âŒ Failed to publish $project_name"
              fi
            fi
          done
          
          echo "âœ… All done!"
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./nupkgs/*.nupkg
          generate_release_notes: true